# oe-raspqt
Minimal image required to boot to QT application on Raspberry Pi

# Getting Started
## Clone all Submodules
```
git submodule update --init --recursive
```

## Navigate to poky
````
cd poky
````

## Source Env
````
source oe-init-build-env
````

## Set Local Conf

### Change Machine Type
```
MACHINE ?= "raspberrypi4-64"
``` 

### Set AUTHORIZED_KEYS_FILE_PATH
```
AUTHORIZED_KEYS_FILE_PATH="<path_to_authorized_keys>"
```
authorized_keys should be a file containing the public key you wish to use to access the rasperry pi

### Optional: Set number of threads for bitbake and make
```
BB_NUMBER_THREADS = "16"
PARALLEL_MAKE = "-j 16"
```

## Add Layers to build/conf/bblayers.conf
```
  meta-raspberrypi
  meta-rpilinux
  meta-openembedded/meta-oe
  meta-openembedded/meta-python
  meta-qt6
  meta-rauc
```

# Build
Full Image

```
bitbake rpilinux-image
```

Bundle Update

```
bitbake update-bundle
```

# Output
`/tmp/deploy/images/raspberrypi4-64/rpilinux-image-raspberrypi4-64.wic.bz2`
Can be flashed to sd card using
```
sudo bmaptool copy rpilinux-image-raspberrypi4-64.wic.bz2 /dev/sdb
```
where `/dev/sdb` is the location of the sd card

`bmaptool` can be installed on Ubuntu via apt:
`sudo apt install bmap-tools`

[flashing reference](https://github.com/agherzan/meta-raspberrypi/issues/637)

# Current Status
* Image boots
* login is root
* basic additions work (python numpy)
* rootfs size 444 MB

## QT
* Can build QT application and launch at boot
* test application is `stocqt` which gets installed with a service file to automatically start at startup

## Updates
The updater runs on a `update.sha256` file. This file is created by running 
```
sha256sum "update_file_name" > update.sha256
```

There are two options for updating:
1. Using the `.raucb` file generated by `bitbake update-bundle`
   * This will run a rauc install on the file and reboot to the new rootfs
2. Using a zip file. This will unzip the file to the home directory and reboot
   * This is meant to be used if are mainly running a single applications. The zip file can contain an updated application or config files. Then the system just needs to be configured to start the application from the home directory and updates will take affect on a reboot. Or you can sym link the application in the home directory to `/usr/bin/`

The updater only checks if the `update.sha256` file is different than the last one. There is currently no check on the sha sum or on the date of the files.

The automounting of the USB's could be improved currently it uses the label so in order for the update to work when a drive is plugged in the drive needs to have a second partition with the label "UPDATE"
Specifically `run-media-DATA\x2dsda1.mount` is used to trigger the update script

### Example Update Process USB:
1. Create a USB drive with 2 partitions second partition must be labeled "UPDATE"
2. Copy contents onto the UPDATE partition of the USB drive
   * This can either be the zipped contents you want installed to the home directory or the rauc update file

3. Create the `update.sha256` file
   ```
   sha256sum <zip_file_name> > update.sha256`
   ```
   or
    ```
   sha256sum update-bundle-raspberrypi4-64.raucb > update.sha256`
   ```
4. Put USB drive into Raspberry and the update should start automatically
5. The update service is `updater.service` so logs can be checked with either
```
journalctl -u updater.service
```
or
```
systemctl status updater
```

### Network Update:
The network update looks for the `update.sha256` on a file server with the ip and port defined in `updater.sh` this can be changed before building the image or changed on the device. Once the IP and port are set correctly you can either run the script manually on the device or every boot the device will look for an update form that IP. This is done with `net-updater.service` 

### Network Update Example:
To do a bundle update you can go to the build output `/tmp/deploy/images/raspberrypi4-64/` after having run
```
bitbake update-bundle
```
and create the `update.sha256` file with:

```
sha256sum update-bundle-raspberrypi4-64.raucb > update.sha256`
```
Then you can create a file server with python by running
```
python3 -m http.server
```
This will create a file server at port 8000

Then you can either manually run `updater.sh` or restart the `net-updater.service`
Logs can be found via:
```
journalctl -u net-updater.service
```
or
```
systemctl status net-updater
```

# References
Started with [Hacking Raspberry Pi 4 with Yocto](https://lancesimms.com/RaspberryPi/HackingRaspberryPi4WithYocto_Introduction.html)

Rauc Updates: [meta-rauc-raspberrypi](https://github.com/rauc/meta-rauc-community/tree/master/meta-rauc-raspberrypi)

[Poky](https://git.yoctoproject.org/poky)

# Work in Progress
## Console Rendering Issues
I have had some issues with the console rendering ontop of the QT application
To fix this I have disabled the `getty@tty1.service` you can still ssh into the machine and log in to a console but in order to login via the screen I think you would need to renable this. This is in the `rpilinux-image.bb` recipe `ROOTFS_POSTPROCESS_COMMAND += "remove_tty1_service; "`
 
# TODO
* Figure out how to have `bblayers.conf` automatically include the required layers
```
  meta-raspberrypi
  meta-rpilinux
  meta-openembedded/meta-oe
  meta-openembedded/meta-python
  meta-qt6
```

* Figure out mDNS or a method to broadcast / know IP Address

* Improve automounting for more seemless update with USB
* Currently the update script has to remount the usb drive with proper permissions to be able to do a rauc install from the USB drive. It would be nice if this wasn't the case.